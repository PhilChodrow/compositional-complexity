---
title: "Spatial Compositional Complexity"
author: "Phil"
date: "March 23, 2016"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 1
    theme: flatly
    code_folding: hide
---

# Introduction

The purpose of this document is to fix notation and establish preliminary results for an approach to spatial compositional complexity measurement using logratio transforms. See [the notes](https://github.com/PhilChodrow/compositional-complexity/blob/master/methods/logratio.pdf) for a full mathematical development of the topic. 

Our goal is to test these methods on census data. 

# Analysis


## Retrieve Data

```{r params, message=FALSE, warning=FALSE}
# PARAMS
# But figure out how to do parameterized reports eventually

state    <- 'MA'
counties <- c(025)
```

```{r library, message=FALSE, warning=FALSE}
library(tigris)
library(acs)
library(stringr)
library(dplyr)
library(leaflet)
library(rgeos)
```

## Retrieve Data
```{r get_data, message=FALSE, warning=FALSE}
income <-acs.fetch(endyear = 2012, 
                  span = 5, 
                  geography = geo.make(state = state, county = counties, tract = '*', block.group = '*'),
                  table.number = "B19001", 
                  col.names = "pretty")

blocks <- block_groups(state = state, county = counties, cb=TRUE)
```

```{r viz, message=FALSE, warning=FALSE}
income_df <- cbind(data.frame(income@geography), 
                   data.frame(income@estimate)) %>% 
    tbl_df %>%
    mutate(GEOID = paste0(str_pad(state, 2, 'left', pad = '0'),
                          str_pad(county, 3, 'left', pad = '0'),
                          str_pad(tract, 6, 'left', pad = '0'),
                          str_pad(blockgroup, 1, 'left', pad = '0'))) %>%
    mutate(percent = 100 * Household.Income..Less.than..10.000 / Household.Income..Total.)

income_merged <- geo_join(blocks, income_df, "GEOID", "GEOID") 

income_merged@data <- income_merged@data %>%
    mutate(ID = row.names(income_merged))

popup <- paste0('Total Respondents: ', income_merged$Household.Income..Total.)
pal <- colorNumeric(
  palette = "YlGnBu",
  domain = income_merged$percent
)

map <-leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data = income_merged, 
              fillColor = ~pal(percent), 
              color = "#b2aeae", # you need to use hex colors
              fillOpacity = 0.7, 
              weight = 1, 
              smoothFactor = 0.2,
              popup = popup) %>%
  addLegend(pal = pal, 
            values = income_merged$percent, 
            position = "bottomright", 
            title = "Percent of Households<br>below $10k",
            labFormat = labelFormat(suffix = "%")) 
map 
```

```{r}
centroids <- gCentroid(income_merged,byid=TRUE) # requires rgeos
centroids <- centroids@coords
write.csv(centroids, 'centroids.csv')
write.csv(income_merged@data, 'income.csv')
```

## Clean Data

- Matrix of locations; i.e. centroids of population tracts
- Matrix of data

## Write Core Functions

- Compute objective function
- Compute row-wise entropy of data
- Compute spatial influence function values

## Implement Gradient Descent

- Consider that it may be best to use a pre-existing R package for this task, depending on how computationally intensive this turns out to be. 

## Analyze results
How did we do?
- Curves of params vs. information loss
- Consider whether there might be an appropriate normalizer for comparisons between cities or between different indicators in the same city. 
- Under what circumstances would we say that the model "fails"?

## Additional software

- Pre-processing script
- Core function definitions (as a package?) See [this](http://rmflight.github.io/posts/2014/07/analyses_as_packages.html) and [this](http://rmflight.github.io/posts/2014/07/vignetteAnalysis.html) for the why and how. 
- makefile (parameterized?)
